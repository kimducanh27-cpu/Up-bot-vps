<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm Tra Botnet - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #0d1117;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #161b22;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }

        .header h1 {
            color: #58a6ff;
            font-size: 1.5em;
        }

        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .status.safe {
            background: #238636;
        }

        .status.danger {
            background: #da3633;
            animation: pulse 1s infinite;
        }

        .status.scanning {
            background: #1f6feb;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #238636;
            color: white;
        }

        .btn-danger {
            background: #da3633;
            color: white;
        }

        .btn-info {
            background: #1f6feb;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #161b22;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #30363d;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .label {
            color: #8b949e;
            margin-top: 5px;
        }

        .stat-card.blue .value {
            color: #58a6ff;
        }

        .stat-card.green .value {
            color: #3fb950;
        }

        .stat-card.yellow .value {
            color: #d29922;
        }

        .stat-card.red .value {
            color: #f85149;
        }

        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: #161b22;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #30363d;
        }

        .panel h2 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }

        .threat-card {
            background: #0d1117;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .threat-card.safe {
            border-color: #3fb950;
        }

        .threat-card.warning {
            border-color: #d29922;
        }

        .threat-card.danger {
            border-color: #f85149;
            background: #1a0000;
        }

        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .threat-name {
            font-weight: bold;
        }

        .threat-card.danger .threat-name {
            color: #f85149;
        }

        .threat-card.warning .threat-name {
            color: #d29922;
        }

        .threat-card.safe .threat-name {
            color: #3fb950;
        }

        .threat-info {
            color: #8b949e;
            font-size: 0.9em;
        }

        .threat-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-kill {
            background: #da3633;
            color: white;
        }

        .btn-block {
            background: #d29922;
            color: white;
        }

        .btn-small:hover {
            opacity: 0.8;
        }

        .info-btn {
            background: #1f6feb;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 11px;
        }

        .empty-msg {
            text-align: center;
            color: #8b949e;
            padding: 30px;
        }

        .list {
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 800px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üõ°Ô∏è KI·ªÇM TRA BOTNET</h1>
        <div id="status" class="status safe">‚úÖ AN TO√ÄN</div>
    </div>

    <div class="controls">
        <button id="btnScan" class="btn btn-primary" onclick="quetHeThong()">üîç QU√âT H·ªÜ TH·ªêNG</button>
        <button id="btnAI" class="btn btn-info" onclick="phanTichAI()" disabled>ü§ñ PH√ÇN T√çCH AI</button>
        <button id="btnKillAll" class="btn btn-danger" onclick="dietTatCa()" disabled>üíÄ DI·ªÜT T·∫§T C·∫¢</button>
    </div>

    <div class="stats">
        <div class="stat-card blue">
            <div class="value" id="statConn">0</div>
            <div class="label">K·∫øt N·ªëi M·∫°ng</div>
        </div>
        <div class="stat-card green">
            <div class="value" id="statProc">0</div>
            <div class="label">Ti·∫øn Tr√¨nh</div>
        </div>
        <div class="stat-card yellow">
            <div class="value" id="statWarn">0</div>
            <div class="label">C·∫£nh B√°o</div>
        </div>
        <div class="stat-card red">
            <div class="value" id="statDanger">0</div>
            <div class="label">Nguy Hi·ªÉm</div>
        </div>
    </div>

    <div class="panels">
        <div class="panel">
            <h2>üåê K·∫æT N·ªêI M·∫†NG</h2>
            <div id="connList" class="list">
                <div class="empty-msg">Nh·∫•n "QU√âT H·ªÜ TH·ªêNG" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
            </div>
        </div>
        <div class="panel">
            <h2>‚öôÔ∏è TI·∫æN TR√åNH ƒê√ÅNG NG·ªú</h2>
            <div id="procList" class="list">
                <div class="empty-msg">Nh·∫•n "QU√âT H·ªÜ TH·ªêNG" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
            </div>
        </div>
    </div>

    <script>
        let duLieu = null;

        // C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI
        function capNhatStatus(loai, text) {
            const el = document.getElementById('status');
            el.className = 'status ' + loai;
            el.textContent = text;
        }

        // QU√âT H·ªÜ TH·ªêNG
        async function quetHeThong() {
            const btn = document.getElementById('btnScan');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang qu√©t...';
            capNhatStatus('scanning', 'üîÑ ƒêANG QU√âT...');

            try {
                // G·ªçi API qu√©t
                const res = await fetch('/api/scan', { method: 'POST' });
                const data = await res.json();
                console.log('K·∫øt qu·∫£ qu√©t:', data);

                if (data.success) {
                    // C·∫≠p nh·∫≠t s·ªë li·ªáu
                    document.getElementById('statConn').textContent = data.stats.connections;
                    document.getElementById('statProc').textContent = data.stats.processes;
                    document.getElementById('statWarn').textContent = data.stats.warnings;
                    document.getElementById('statDanger').textContent = data.stats.dangers;

                    // L·∫•y chi ti·∫øt
                    const res2 = await fetch('/api/results');
                    duLieu = await res2.json();
                    console.log('Chi ti·∫øt:', duLieu);

                    // Hi·ªÉn th·ªã danh s√°ch
                    hienThiKetNoi(duLieu.connections);
                    hienThiTienTrinh(duLieu.processes);

                    // B·∫≠t n√∫t
                    document.getElementById('btnAI').disabled = false;

                    if (data.stats.dangers > 0) {
                        document.getElementById('btnKillAll').disabled = false;
                        capNhatStatus('danger', 'üî¥ PH√ÅT HI·ªÜN NGUY HI·ªÇM');
                    } else if (data.stats.warnings > 0) {
                        capNhatStatus('scanning', '‚ö†Ô∏è C√ì C·∫¢NH B√ÅO');
                    } else {
                        capNhatStatus('safe', '‚úÖ AN TO√ÄN');
                    }

                    alert('‚úÖ QU√âT HO√ÄN T·∫§T!\n\nüìä K·∫øt n·ªëi: ' + data.stats.connections +
                        '\n‚öôÔ∏è Ti·∫øn tr√¨nh: ' + data.stats.processes +
                        '\n‚ö†Ô∏è C·∫£nh b√°o: ' + data.stats.warnings +
                        '\nüî¥ Nguy hi·ªÉm: ' + data.stats.dangers);
                }
            } catch (err) {
                console.error('L·ªói:', err);
                alert('‚ùå L·ªói: ' + err.message);
            }

            btn.disabled = false;
            btn.textContent = 'üîç QU√âT H·ªÜ TH·ªêNG';
        }

        // HI·ªÇN TH·ªä K·∫æT N·ªêI
        function hienThiKetNoi(conns) {
            const el = document.getElementById('connList');
            if (!conns || conns.length === 0) {
                el.innerHTML = '<div class="empty-msg">Kh√¥ng c√≥ k·∫øt n·ªëi nghi ng·ªù</div>';
                return;
            }

            // S·∫Øp x·∫øp nguy hi·ªÉm l√™n ƒë·∫ßu
            conns.sort((a, b) => {
                const order = { danger: 0, warning: 1, safe: 2 };
                return order[a.threat_level] - order[b.threat_level];
            });

            el.innerHTML = conns.slice(0, 15).map(c => `
        <div class="threat-card ${c.threat_level}">
            <div class="threat-header">
                <span class="threat-name">${c.process_name} (PID: ${c.pid})</span>
                <button class="info-btn" title="Protocol: ${c.protocol}\nLocal: ${c.local}\nRemote: ${c.remote_ip}:${c.remote_port}\nState: ${c.state}">i</button>
            </div>
            <div class="threat-info">‚Üí ${c.remote_ip}:${c.remote_port}</div>
            ${c.threat_level !== 'safe' ? `
            <div class="threat-actions">
                <button class="btn-small btn-kill" onclick="dietTienTrinh('${c.pid}')">üíÄ DI·ªÜT</button>
                <button class="btn-small btn-block" onclick="chanIP('${c.remote_ip}')">üö´ CH·∫∂N IP</button>
            </div>
            ` : ''}
        </div>
    `).join('');
        }

        // HI·ªÇN TH·ªä TI·∫æN TR√åNH
        function hienThiTienTrinh(procs) {
            const el = document.getElementById('procList');
            const suspicious = procs.filter(p => p.threat_level !== 'safe');

            if (suspicious.length === 0) {
                el.innerHTML = '<div class="empty-msg" style="color: #3fb950;">‚úÖ Kh√¥ng c√≥ ti·∫øn tr√¨nh nghi ng·ªù</div>';
                return;
            }

            el.innerHTML = suspicious.map(p => `
        <div class="threat-card ${p.threat_level}">
            <div class="threat-header">
                <span class="threat-name">${p.name}</span>
                <button class="info-btn" title="ƒê∆∞·ªùng d·∫´n: ${p.path || 'Kh√¥ng x√°c ƒë·ªãnh'}\nPID: ${p.pid}">i</button>
            </div>
            <div class="threat-info">PID: ${p.pid}</div>
            <div class="threat-actions">
                <button class="btn-small btn-kill" onclick="dietTienTrinh('${p.pid}')">üíÄ DI·ªÜT NGAY</button>
            </div>
        </div>
    `).join('');
        }

        // DI·ªÜT TI·∫æN TR√åNH
        async function dietTienTrinh(pid) {
            console.log('Y√™u c·∫ßu di·ªát PID:', pid);

            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N DI·ªÜT TI·∫æN TR√åNH?\n\nPID: ' + pid + '\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }

            try {
                const res = await fetch('/api/kill', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid: pid })
                });

                const data = await res.json();
                console.log('K·∫øt qu·∫£ di·ªát:', data);

                if (data.success) {
                    alert('‚úÖ TH√ÄNH C√îNG!\n\n' + data.message);
                    quetHeThong(); // Qu√©t l·∫°i
                } else {
                    alert('‚ùå TH·∫§T B·∫†I!\n\n' + data.message + '\n\nüí° M·∫πo: Th·ª≠ ch·∫°y Flask v·ªõi quy·ªÅn Administrator');
                }
            } catch (err) {
                console.error('L·ªói di·ªát:', err);
                alert('‚ùå L·ªñI K·∫æT N·ªêI!\n\n' + err.message);
            }
        }

        // CH·∫∂N IP
        async function chanIP(ip) {
            console.log('Y√™u c·∫ßu ch·∫∑n IP:', ip);

            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N CH·∫∂N IP?\n\nIP: ' + ip + '\n\nIP s·∫Ω b·ªã block b·ªüi Windows Firewall!')) {
                return;
            }

            try {
                const res = await fetch('/api/block', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });

                const data = await res.json();
                console.log('K·∫øt qu·∫£ ch·∫∑n:', data);

                if (data.success) {
                    alert('‚úÖ TH√ÄNH C√îNG!\n\n' + data.message);
                } else {
                    alert('‚ùå TH·∫§T B·∫†I!\n\n' + data.message + '\n\nüí° M·∫πo: Th·ª≠ ch·∫°y Flask v·ªõi quy·ªÅn Administrator');
                }
            } catch (err) {
                console.error('L·ªói ch·∫∑n:', err);
                alert('‚ùå L·ªñI K·∫æT N·ªêI!\n\n' + err.message);
            }
        }

        // DI·ªÜT T·∫§T C·∫¢
        async function dietTatCa() {
            if (!duLieu) return;

            const dangers = [
                ...duLieu.connections.filter(c => c.threat_level === 'danger'),
                ...duLieu.processes.filter(p => p.threat_level === 'danger')
            ];

            if (dangers.length === 0) {
                alert('Kh√¥ng c√≥ m·ª•c nguy hi·ªÉm n√†o c·∫ßn di·ªát');
                return;
            }

            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N DI·ªÜT T·∫§T C·∫¢ ' + dangers.length + ' M·ª§C NGUY HI·ªÇM?')) {
                return;
            }

            let killed = 0;
            for (const item of dangers) {
                try {
                    await fetch('/api/kill', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pid: item.pid })
                    });
                    killed++;
                } catch (e) { }
            }

            alert('‚úÖ ƒê√£ x·ª≠ l√Ω ' + killed + '/' + dangers.length + ' m·ª•c');
            quetHeThong();
        }

        // PH√ÇN T√çCH AI
        async function phanTichAI() {
            const btn = document.getElementById('btnAI');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang ph√¢n t√≠ch...';

            try {
                const res = await fetch('/api/analyze', { method: 'POST' });
                const data = await res.json();
                console.log('K·∫øt qu·∫£ AI:', data);

                if (data.success && data.analysis) {
                    let msg = 'ü§ñ K·∫æT QU·∫¢ PH√ÇN T√çCH AI\n\n';
                    msg += 'üìä M·ª©c ƒë·ªô: ' + data.analysis.risk_level + '\n\n';
                    msg += 'üìù T√≥m t·∫Øt: ' + data.analysis.summary + '\n\n';

                    if (data.analysis.threats && data.analysis.threats.length > 0) {
                        msg += '‚ö†Ô∏è M·ªëi ƒëe d·ªça:\n';
                        data.analysis.threats.forEach((t, i) => {
                            msg += (i + 1) + '. ' + t.name + '\n';
                        });
                    }

                    alert(msg);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }

            btn.disabled = false;
            btn.textContent = 'ü§ñ PH√ÇN T√çCH AI';
        }
    </script>
</body>

</html>